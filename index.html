<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BusyWeeksAtSchool</title>
  <style>
    :root{
      --col-gap:8px;
      --col-width:90px;
      --font: 'Segoe UI', Roboto, Arial, sans-serif;
      --header-h:64px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:var(--font);background:#0f172a;color:#e6eef8;display:flex;flex-direction:column;height:100vh}
    header{display:flex;align-items:center;gap:12px;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,0.03);height:var(--header-h)}
    .left-toggle{margin-right:6px}
    .left-toggle button{font-size:18px;padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe2ff;cursor:pointer;transition:all 0.2s}
    .left-toggle button:hover{background:rgba(255,255,255,0.03)}
    header h1{margin:0;font-size:18px}
    .top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}

    button{background:#233b7a;border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s}
    button:hover{background:#2a4690}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    button.ghost:hover{background:rgba(255,255,255,0.03)}
    button.btn-floating{background:#233b7a;position:relative;transition:all 0.2s}
    button.btn-floating.empty{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#9fb0ff}
    .badge{background:#ff6b6b;color:white;border-radius:999px;padding:3px 8px;font-size:12px;margin-left:6px}

    main{display:flex;flex:1;min-height:0;overflow:hidden}
    .sidebar{width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:16px;overflow:auto;transition:width 0.18s ease,opacity 0.18s}
    .sidebar.hidden{display:none}
    .content{flex:1;display:flex;flex-direction:column;min-width:0;gap:8px;padding:10px 12px;min-height:0}

    /* Courses list - compact */
    .courses-compact{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;padding:12px;background:rgba(255,255,255,0.01);border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .course-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(255,255,255,0.03);border-radius:20px;font-size:13px;border:1px solid rgba(255,255,255,0.04);transition:all 0.2s;cursor:pointer}
    .course-chip:hover{background:rgba(255,255,255,0.05);transform:translateY(-1px)}
    .course-chip .color-dot{width:12px;height:12px;border-radius:50%}
    .course-chip .actions{display:none;margin-left:4px;gap:4px}
    .course-chip:hover .actions{display:flex}
    .course-chip button{padding:2px 6px;font-size:11px;background:rgba(255,255,255,0.1)}

    /* Section titles */
    .section-title{font-size:14px;font-weight:600;color:#cfe2ff;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.03)}

    /* Board */
    .board-wrap{flex:1;min-height:0;display:flex;flex-direction:column}
    .board-scroll{overflow:auto;flex:1}
    .board{display:grid;grid-template-columns:repeat(14, var(--col-width));gap:var(--col-gap);align-items:end;padding:12px;height:100%}

    .col{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:8px;padding:8px 6px;display:flex;flex-direction:column;justify-content:flex-end;min-height:120px;position:relative;border:1px solid rgba(255,255,255,0.04);transition:transform .18s}
    .col.selected{box-shadow:0 10px 30px rgba(21,56,150,0.25);transform:translateY(-6px);border-color:rgba(120,160,255,0.22)}
    .col-header{font-size:12px;text-align:center;margin-bottom:6px}
    .week-range{font-size:10px;color:#9fb0ff;opacity:0.8}

    .stack{display:flex;flex-direction:column-reverse;gap:4px;min-height:60px;align-items:stretch}

    /* Smaller blocks with better text sizing */
    .eval{padding:5px 6px;font-size:11px;border-radius:6px;color:#041026;display:flex;flex-direction:column;justify-content:center;box-shadow:0 2px 6px rgba(2,6,23,0.4);cursor:pointer;overflow:hidden;position:relative;transition:all 0.2s}
    .eval:hover{transform:scale(1.02);box-shadow:0 4px 10px rgba(2,6,23,0.6);z-index:10}
    .eval .line{display:block;line-height:1.2;white-space:nowrap;text-overflow:ellipsis;overflow:hidden}
    .eval .eval-title{font-weight:600;font-size:10px;margin-bottom:2px}
    .eval .eval-course{font-size:9px;opacity:0.8}
    .eval .eval-date{font-size:9px;opacity:0.7;margin-top:1px}

    /* Tooltip on hover */
    .eval-tooltip{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#1a2844;color:#e6eef8;padding:8px 10px;border-radius:6px;font-size:11px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,0.3);margin-bottom:6px}
    .eval:hover .eval-tooltip{opacity:1}
    .eval-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1a2844}

    /* Color swatches */
    .color-orange{background:linear-gradient(135deg,#ffb366,#ff9147)}
    .color-blue{background:linear-gradient(135deg,#7fb5ff,#5294ff)}
    .color-green{background:linear-gradient(135deg,#7fdd82,#5fc864)}
    .color-pink{background:linear-gradient(135deg,#ff8fc7,#ff6bb3)}
    .color-violet{background:linear-gradient(135deg,#b798ff,#9b75ff)}
    .color-yellow{background:linear-gradient(135deg,#ffe066,#ffd433)}
    .color-custom{background:linear-gradient(135deg,#e0e0e0,#c5c5c5)}

    .floating-container{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.008));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column}
    .floating-list{display:flex;gap:8px;overflow:auto;padding:6px;align-items:center}
    .floating-list .eval{min-width:140px;flex:0 0 auto}

    /* Forms - cleaner design */
    label{display:block;font-size:12px;margin-top:10px;color:#9fb0ff;font-weight:500}
    input[type="text"], input[type="date"], select, textarea, input[type="number"]{width:100%;padding:8px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);margin-top:4px;background:rgba(255,255,255,0.02);color:#e6eef8;font-size:13px;transition:all 0.2s}
    input:focus, select:focus, textarea:focus{outline:none;border-color:rgba(120,160,255,0.3);background:rgba(255,255,255,0.03)}
    select{appearance:none;-webkit-appearance:none;-moz-appearance:none;padding-right:30px;color:#cfe2ff}
    select option{color:#041026;background:#f4f7ff}
    .form-row{display:flex;gap:8px}
    .form-row > *{flex:1}
    .form-section{background:rgba(255,255,255,0.01);padding:16px;border-radius:8px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.03)}

    .modal{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.7);z-index:9999;backdrop-filter:blur(4px)}
    .modal .card{background:#0a1628;padding:20px;border-radius:12px;min-width:400px;border:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 40px rgba(0,0,0,0.5)}
    .modal h3{margin-top:0;color:#cfe2ff}

    footer{padding:8px 14px;border-top:1px solid rgba(255,255,255,0.03);font-size:13px;color:#9fb0ff}

    /* Loading state */
    .loading{opacity:0.5;pointer-events:none}
    .spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.1);border-top-color:#cfe2ff;border-radius:50%;animation:spin 0.8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:1000px){.sidebar{display:none}.board{grid-template-columns:repeat(14,80px)}}
  </style>
</head>
<body>
  <header>
    <div class="left-toggle">
      <button id="btnToggleSidebar" aria-label="Basculer la barre latérale">☰</button>
    </div>
    <h1>BusyWeeksAtSchool</h1>

    <div class="top-actions">
      <button id="btnToggleFloating" class="btn-floating">Évals sans date <span id="floatingBadge" class="badge" style="display:none">0</span></button>
      <button id="btnAddEval">+ Ajouter évaluation</button>
      <button id="btnExportLocal" class="ghost">Exporter (local)</button>
      <button id="btnImportLocal" class="ghost">Importer (local)</button>
      <button id="btnReset" class="ghost" title="Réinitialiser données">Reset</button>
    </div>
  </header>

  <main>
    <aside class="sidebar" id="sidebar">
      <!-- Compact courses list -->
      <div class="courses-compact" id="coursesList"></div>

      <!-- Add course form -->
      <div class="form-section">
        <div class="section-title">Ajouter un cours</div>
        <input id="courseName" type="text" placeholder="Ex: MAT210" />
        <select id="courseClass" style="margin-top:8px">
          <option value="color-orange">Orange</option>
          <option value="color-blue">Bleu</option>
          <option value="color-green">Vert</option>
          <option value="color-pink">Rose</option>
          <option value="color-violet">Violet</option>
          <option value="color-yellow">Jaune</option>
          <option value="color-custom">Personnalisé</option>
        </select>
        <button id="btnAddCourse" style="width:100%;margin-top:10px">Ajouter le cours</button>
      </div>

      <!-- Quick eval form -->
      <div class="form-section">
        <div class="section-title">Ajout rapide d'évaluation</div>
        <input id="quickTitle" type="text" placeholder="Mini-test 1" />
        <select id="quickCourse" style="margin-top:8px" required></select>
        <div class="form-row" style="margin-top:8px">
          <input id="quickDate" type="date" placeholder="Date" />
          <input id="quickWeek" type="number" min="1" max="14" placeholder="Semaine" />
        </div>
        <input id="quickPerc" type="text" placeholder="Pourcentage (ex: 10%)" style="margin-top:8px" />
        <button id="btnQuickAdd" style="width:100%;margin-top:10px">Ajouter l'évaluation</button>
      </div>
    </aside>

    <section class="content">
      <div class="board-wrap">
        <div class="board-scroll" id="boardScroll">
          <div id="board" class="board"></div>
        </div>
      </div>

      <div id="floatingContainer" class="floating-container" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <strong>Évaluations sans date ni semaine</strong>
          <span class="muted" style="font-size:11px">Double-cliquez pour éditer</span>
        </div>
        <div id="floatingList" class="floating-list"></div>
      </div>
    </section>
  </main>

  <!-- Edit modal -->
  <div id="modal" class="modal">
    <div class="card">
      <h3 id="modalTitle">Ajouter / Modifier évaluation</h3>
      <div style="margin-top:16px">
        <label>Nom de l'évaluation</label>
        <input id="evTitle" type="text" required />
        <label>Cours</label>
        <select id="evCourse" required></select>
        <div class="form-row">
          <div><label>Date</label><input id="evDate" type="date" /></div>
          <div><label>Semaine (1-14)</label><input id="evWeek" type="number" min="1" max="14" /></div>
        </div>
        <label>Pourcentage</label>
        <input id="evPerc" type="text" placeholder="Ex: 10%" />
        <label>Notes</label>
        <textarea id="evNote" rows="2"></textarea>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button id="saveEv">Enregistrer</button>
          <button id="cancelEv" class="ghost">Annuler</button>
          <button id="deleteEv" class="ghost" style="margin-left:auto;color:#ff8080">Supprimer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reset confirmation modal -->
  <div id="resetModal" class="modal">
    <div class="card">
      <h3>Réinitialiser les données</h3>
      <p>Voulez-vous exporter vos données avant de réinitialiser ?</p>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button id="btnResetExport">Exporter puis réinitialiser</button>
        <button id="btnResetDirect">Réinitialiser directement</button>
        <button id="btnResetCancel" class="ghost">Annuler</button>
      </div>
    </div>
  </div>

  <input id="importFile" type="file" accept=".json" style="display:none" />

  <footer>Application de gestion de charge de travail par semaine - Session automne 2025</footer>

  <script>
  const STORAGE_KEY = 'charge_app_v4_data';

  let gapiInitialized = false;
  let tokenClient = null;
  let accessToken = null;
  let hasChanges = false;

  function defaultState(){
    return {
      courses: [
        {id: 'MAT210', name: 'MAT210', cls:'color-orange'},
        {id: 'MAT145', name: 'MAT145', cls:'color-blue'},
        {id: 'LOG121', name: 'LOG121', cls:'color-green'},
        {id: 'IND105', name: 'IND105', cls:'color-pink'}
      ],
      evaluations: []
    };
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : defaultState();
    }catch(e){ 
      console.error('Load error', e); 
      return defaultState(); 
    }
  }

  function save(state){ 
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); 
    hasChanges = true;
  }

  let state = load();

  // Session weeks setup
  const sessionStart = new Date(2025,8,1);
  const weeks = Array.from({length:14}, (_,i)=>{
    const mon = new Date(sessionStart.getFullYear(), sessionStart.getMonth(), sessionStart.getDate() + i*7);
    const fri = new Date(mon.getFullYear(), mon.getMonth(), mon.getDate() + 4);
    return {index: i+1, mon, fri};
  });

  // UI elements
  const board = document.getElementById('board');
  const sidebar = document.getElementById('sidebar');
  const btnToggleSidebar = document.getElementById('btnToggleSidebar');
  const btnToggleFloating = document.getElementById('btnToggleFloating');
  const floatingContainer = document.getElementById('floatingContainer');
  const floatingList = document.getElementById('floatingList');
  const floatingBadge = document.getElementById('floatingBadge');
  const importFile = document.getElementById('importFile');
  const driveModal = document.getElementById('driveModal');
  const resetModal = document.getElementById('resetModal');
  const modal = document.getElementById('modal');

  // ========== Utility Functions ==========
  function uid(prefix='id'){ 
    return prefix + '-' + Math.random().toString(36).slice(2,9); 
  }

  function clearChildren(el){ 
    while(el.firstChild) el.removeChild(el.firstChild); 
  }

  function findWeekForDate(dstr){
    if(!dstr) return null;
    const d = new Date(dstr);
    for(const w of weeks){
      const mon = new Date(w.mon.getFullYear(), w.mon.getMonth(), w.mon.getDate());
      const fri = new Date(w.fri.getFullYear(), w.fri.getMonth(), w.fri.getDate());
      fri.setHours(23,59,59);
      if(d.getTime() >= mon.getTime() && d.getTime() <= fri.getTime()) return w.index;
    }
    return null;
  }

  function formatDate(dstr){
    if(!dstr) return '';
    const d = new Date(dstr);
    const day = String(d.getDate()).padStart(2,'0');
    const month = String(d.getMonth() + 1).padStart(2,'0');
    const year = d.getFullYear();
    return `${day}-${month}-${year}`;
  }

  function escapeHtml(s){ 
    if(!s) return ''; 
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); 
  }

  // ========== Course Management ==========
  function renderCourses(){
    const coursesList = document.getElementById('coursesList');
    const evCourseSel = document.getElementById('evCourse');
    const quickCourse = document.getElementById('quickCourse');
    
    clearChildren(coursesList);
    clearChildren(evCourseSel);
    clearChildren(quickCourse);
    
    state.courses.forEach(c => {
      // Compact course chip
      const chip = document.createElement('div');
      chip.className = 'course-chip';
      chip.innerHTML = `
        <div class="color-dot ${c.cls}"></div>
        <span>${c.name}</span>
        <div class="actions">
          <button onclick="editCourse('${c.id}')">✏️</button>
          <button onclick="deleteCourse('${c.id}')">🗑️</button>
        </div>
      `;
      coursesList.appendChild(chip);
      
      // Options for selects
      const opt1 = document.createElement('option');
      opt1.value = c.id;
      opt1.textContent = c.name;
      evCourseSel.appendChild(opt1);
      
      const opt2 = opt1.cloneNode(true);
      quickCourse.appendChild(opt2);
    });
  }

  window.editCourse = function(id){
    const c = state.courses.find(x => x.id === id);
    if(!c) return;
    const newName = prompt('Nouveau nom du cours:', c.name);
    if(!newName) return;
    c.name = newName;
    save(state);
    renderCourses();
    renderBoard();
  }

  window.deleteCourse = function(id){
    if(!confirm('Supprimer ce cours et toutes ses évaluations ?')) return;
    state.courses = state.courses.filter(c => c.id !== id);
    state.evaluations = state.evaluations.filter(e => e.course !== id);
    save(state);
    renderCourses();
    renderBoard();
  }

  // ========== Board Rendering ==========
  function renderBoard(){
    clearChildren(board);
    clearChildren(floatingList);
    
    const map = {};
    for(const w of weeks) map[w.index] = [];
    const floating = [];
    
    state.evaluations.forEach(ev => {
      if(!ev.date && !ev.week){
        floating.push(ev);
      } else if(ev.date){
        const wk = findWeekForDate(ev.date);
        if(wk) map[wk].push(ev);
      } else if(ev.week){
        if(map[ev.week]) map[ev.week].push(ev);
      }
    });

    weeks.forEach(w => {
      const col = document.createElement('div');
      col.className = 'col';
      col.dataset.week = w.index;
      
      const header = document.createElement('div');
      header.className = 'col-header';
      const mon = w.mon.toLocaleDateString('fr-CA', {day:'2-digit', month:'short'});
      const fri = w.fri.toLocaleDateString('fr-CA', {day:'2-digit', month:'short'});
      header.innerHTML = `
        <div style="font-weight:600">Semaine ${w.index}</div>
        <div class="week-range">${mon} → ${fri}</div>
      `;
      col.appendChild(header);

      const stack = document.createElement('div');
      stack.className = 'stack';
      const items = map[w.index] || [];
      
      items.forEach(item => {
        const courseObj = state.courses.find(c => c.id === item.course);
        const cls = courseObj ? courseObj.cls : 'color-custom';
        const ev = document.createElement('div');
        ev.className = `eval ${cls}`;
        ev.dataset.id = item.id;
        
        // Simplified display
        const dateStr = item.date ? formatDate(item.date) : '';
        ev.innerHTML = `
          <div class="eval-title">${escapeHtml(item.title || '')}</div>
          <div class="eval-course">${escapeHtml(item.course || '')}</div>
          <div class="eval-date">${dateStr}</div>
          <div class="eval-tooltip">
            <strong>${escapeHtml(item.title || '')}</strong><br>
            ${escapeHtml(item.course || '')}<br>
            ${dateStr}
            ${item.percentage ? '<br>' + escapeHtml(item.percentage) : ''}
            ${item.note ? '<br><em>' + escapeHtml(item.note) + '</em>' : ''}
          </div>
        `;
        ev.addEventListener('dblclick', () => openEditModal(item.id));
        stack.appendChild(ev);
      });

      col.appendChild(stack);
      board.appendChild(col);
    });

    // Floating evaluations
    floating.forEach(item => {
      const courseObj = state.courses.find(c => c.id === item.course);
      const cls = courseObj ? courseObj.cls : 'color-custom';
      const ev = document.createElement('div');
      ev.className = `eval ${cls}`;
      ev.dataset.id = item.id;
      ev.innerHTML = `
        <div class="eval-title">${escapeHtml(item.title || '')}</div>
        <div class="eval-course">${escapeHtml(item.course || '')}</div>
        <div class="eval-tooltip">
          <strong>${escapeHtml(item.title || '')}</strong><br>
          ${escapeHtml(item.course || '')}<br>
          Sans date
          ${item.percentage ? '<br>' + escapeHtml(item.percentage) : ''}
          ${item.note ? '<br><em>' + escapeHtml(item.note) + '</em>' : ''}
        </div>
      `;
      ev.addEventListener('dblclick', () => openEditModal(item.id));
      floatingList.appendChild(ev);
    });

    // Update floating button appearance
    const countFloating = floating.length;
    if(countFloating > 0){
      btnToggleFloating.classList.remove('empty');
      floatingBadge.style.display = 'inline-block';
      floatingBadge.textContent = String(countFloating);
      if(floatingContainer.dataset.visible === 'true'){
        floatingContainer.style.display = 'flex';
      }
    } else {
      btnToggleFloating.classList.add('empty');
      floatingBadge.style.display = 'none';
      floatingContainer.style.display = 'none';
    }

    selectCurrentWeekColumn();
  }

  function selectCurrentWeekColumn(){
    const now = new Date();
    let currentWeek = null;
    
    for(const w of weeks){
      const mon = new Date(w.mon);
      const fri = new Date(w.fri);
      fri.setHours(23,59,59);
      if(now >= mon && now <= fri){
        currentWeek = w.index;
        break;
      }
    }
    
    board.querySelectorAll('.col.selected').forEach(c => c.classList.remove('selected'));
    
    if(currentWeek){
      const col = board.querySelector(`.col[data-week="${currentWeek}"]`);
      if(col){
        col.classList.add('selected');
        setTimeout(() => {
          const wrap = document.getElementById('boardScroll');
          const rect = col.getBoundingClientRect();
          const wrapRect = wrap.getBoundingClientRect();
          const offset = rect.left - wrapRect.left - (wrapRect.width/2 - rect.width/2);
          wrap.scrollBy({ left: offset, behavior: 'smooth' });
        }, 100);
      }
    }
  }

  // ========== Modal Management ==========
  let editId = null;

  function openAddModal(){
    editId = null;
    document.getElementById('modalTitle').textContent = 'Ajouter évaluation';
    document.getElementById('evTitle').value = '';
    document.getElementById('evDate').value = '';
    document.getElementById('evWeek').value = '';
    document.getElementById('evPerc').value = '';
    document.getElementById('evNote').value = '';
    document.getElementById('deleteEv').style.display = 'none';
    modal.style.display = 'flex';
  }

  function openEditModal(id){
    const ev = state.evaluations.find(x => x.id === id);
    if(!ev) return;
    
    editId = id;
    document.getElementById('modalTitle').textContent = 'Modifier évaluation';
    document.getElementById('evTitle').value = ev.title || '';
    document.getElementById('evCourse').value = ev.course || '';
    document.getElementById('evDate').value = ev.date ? new Date(ev.date).toISOString().slice(0,10) : '';
    document.getElementById('evWeek').value = ev.week || '';
    document.getElementById('evPerc').value = ev.percentage || '';
    document.getElementById('evNote').value = ev.note || '';
    document.getElementById('deleteEv').style.display = 'inline-block';
    modal.style.display = 'flex';
  }

  // ========== Event Listeners ==========
  
  // Sidebar toggle
  document.getElementById('btnToggleSidebar').addEventListener('click', () => {
    sidebar.classList.toggle('hidden');
    btnToggleSidebar.textContent = sidebar.classList.contains('hidden') ? '☰' : '◀';
  });

  // Floating toggle
  btnToggleFloating.addEventListener('click', () => {
    const vis = floatingContainer.dataset.visible === 'true';
    floatingContainer.dataset.visible = vis ? 'false' : 'true';
    renderBoard();
  });

  // Course management
  document.getElementById('btnAddCourse').addEventListener('click', () => {
    const name = document.getElementById('courseName').value.trim();
    const cls = document.getElementById('courseClass').value;
    if(!name) return alert('Veuillez entrer un nom de cours');
    
    const id = name.replace(/\s+/g,'').toUpperCase();
    if(state.courses.find(c => c.id === id)){
      alert('Ce cours existe déjà');
      return;
    }
    
    state.courses.push({id, name, cls});
    save(state);
    renderCourses();
    document.getElementById('courseName').value = '';
  });

  // Quick add evaluation
  document.getElementById('btnQuickAdd').addEventListener('click', () => {
    const title = document.getElementById('quickTitle').value.trim();
    const course = document.getElementById('quickCourse').value;
    const date = document.getElementById('quickDate').value;
    const week = document.getElementById('quickWeek').value;
    const perc = document.getElementById('quickPerc').value;
    
    if(!title) return alert('Titre requis');
    if(!course) return alert('Cours requis');
    
    const ev = {
      id: uid('ev'),
      title,
      course,
      date: date || null,
      week: week ? parseInt(week) : null,
      percentage: perc,
      note: ''
    };
    
    state.evaluations.push(ev);
    save(state);
    renderBoard();
    
    // Clear form
    document.getElementById('quickTitle').value = '';
    document.getElementById('quickDate').value = '';
    document.getElementById('quickWeek').value = '';
    document.getElementById('quickPerc').value = '';
  });

  // Add evaluation button
  document.getElementById('btnAddEval').addEventListener('click', openAddModal);

  // Modal save
  document.getElementById('saveEv').addEventListener('click', () => {
    const title = document.getElementById('evTitle').value.trim();
    const course = document.getElementById('evCourse').value;
    const date = document.getElementById('evDate').value;
    const week = document.getElementById('evWeek').value;
    const perc = document.getElementById('evPerc').value;
    const note = document.getElementById('evNote').value;
    
    if(!title) return alert('Titre requis');
    
    if(editId){
      const ev = state.evaluations.find(x => x.id === editId);
      if(ev){
        ev.title = title;
        ev.course = course;
        ev.date = date || null;
        ev.week = week ? parseInt(week) : null;
        ev.percentage = perc;
        ev.note = note;
      }
    } else {
      state.evaluations.push({
        id: uid('ev'),
        title,
        course,
        date: date || null,
        week: week ? parseInt(week) : null,
        percentage: perc,
        note
      });
    }
    
    save(state);
    renderBoard();
    modal.style.display = 'none';
  });

  // Modal delete
  document.getElementById('deleteEv').addEventListener('click', () => {
    if(!editId) return;
    if(confirm('Supprimer cette évaluation?')){
      state.evaluations = state.evaluations.filter(x => x.id !== editId);
      save(state);
      renderBoard();
      modal.style.display = 'none';
    }
  });

  // Modal cancel
  document.getElementById('cancelEv').addEventListener('click', () => {
    modal.style.display = 'none';
  });

  // Export/Import local
  document.getElementById('btnExportLocal').addEventListener('click', () => {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `charge_export_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    hasChanges = false;
  });

  document.getElementById('btnImportLocal').addEventListener('click', () => {
    importFile.click();
  });

  importFile.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const imported = JSON.parse(reader.result);
        if(!imported.courses || !imported.evaluations){
          throw new Error('Format invalide');
        }
        if(confirm('Importer ce fichier remplacera toutes vos données. Continuer?')){
          state = imported;
          save(state);
          renderCourses();
          renderBoard();
          alert('Importation réussie!');
        }
      } catch(error){
        alert('Erreur lors de l\'importation: ' + error.message);
      }
    };
    reader.readAsText(file);
    importFile.value = '';
  });

  // Reset with export prompt
  document.getElementById('btnReset').addEventListener('click', () => {
    if(hasChanges){
      resetModal.style.display = 'flex';
    } else {
      if(confirm('Réinitialiser toutes les données?')){
        localStorage.removeItem(STORAGE_KEY);
        state = defaultState();
        save(state);
        renderCourses();
        renderBoard();
        hasChanges = false;
      }
    }
  });

  document.getElementById('btnResetExport').addEventListener('click', () => {
    // Export first
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `charge_backup_before_reset_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    // Then reset
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState();
    save(state);
    renderCourses();
    renderBoard();
    hasChanges = false;
    resetModal.style.display = 'none';
  });

  document.getElementById('btnResetDirect').addEventListener('click', () => {
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState();
    save(state);
    renderCourses();
    renderBoard();
    hasChanges = false;
    resetModal.style.display = 'none';
  });

  document.getElementById('btnResetCancel').addEventListener('click', () => {
    resetModal.style.display = 'none';
  });

  // ESC key to close modals
  window.addEventListener('keydown', (e) => {
    if(e.key === 'Escape'){
      modal.style.display = 'none';
      driveModal.style.display = 'none';
      resetModal.style.display = 'none';
    }
  });

  // ========== Demo Data ==========
  function ensureDefaults(){
    if(state.evaluations.length === 0){
      state.evaluations = [
        {id:'demo1', course:'MAT210', title:'Mini-test 1', percentage:'10%', date:'2025-09-26'},
        {id:'demo2', course:'MAT210', title:'Examen Intra', percentage:'35%', date:'2025-10-20'},
        {id:'demo3', course:'MAT145', title:'Devoir 1', percentage:'15%', date:'2025-09-25'},
        {id:'demo4', course:'LOG121', title:'Labo 1', percentage:'5%', week:3},
        {id:'demo5', course:'IND105', title:'Quiz 1', percentage:'5%', date:'2025-09-29'}
      ];
      save(state);
    }
  }

  // ========== Initialize ==========
  ensureDefaults();
  renderCourses();
  renderBoard();

  // Initialize Google API
  window.onload = () => {
    const script = document.createElement('script');
    script.src = 'https://accounts.google.com/gsi/client';
    script.onload = () => {
      if(typeof gapi !== 'undefined'){
        initializeGapi();
      }
    };
    document.head.appendChild(script);
  };

  </script>
</body>
</html>